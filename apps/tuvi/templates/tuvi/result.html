<!DOCTYPE html>
<html lang="vi">
{% load static %}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>L√° S·ªë T·ª≠ Vi - K·∫øt qu·∫£</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="{% static 'tuvi/style.css' %}?v=210" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- User navigation -->
        <div class="user-nav">
            {% if user.is_authenticated %}
                <span>Xin ch√†o, {{ user.username }}</span>
                <form method="POST" action="{% url 'logout' %}" style="display: inline; margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="user-nav-logout-btn">ƒêƒÉng xu·∫•t</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}">ƒêƒÉng nh·∫≠p</a>
                <a href="{% url 'register' %}">ƒêƒÉng k√Ω</a>
            {% endif %}
        </div>

        <!-- Header v·ªõi n√∫t h√†nh ƒë·ªông -->
        <div class="result-header">
            <h1 class="main-title">L√° S·ªë T·ª≠ Vi</h1>
            <div class="action-buttons">
                <a href="{% url 'lasotuvi_index' %}" class="btn btn-secondary">
                    üìÅ Qu·∫£n l√Ω t·∫•t c·∫£ l√° s·ªë
                </a>
                <a href="{% url 'lasotuvi_new' %}" class="btn btn-primary">
                    + T·∫°o l√° s·ªë m·ªõi
                </a>
            </div>
        </div>

        <!-- K·∫øt qu·∫£ l√° s·ªë -->
        <div id="lasotuvi-result" class="result-container">
            <div class="laso-layout">
                <!-- Sidebar b√™n tr√°i -->
                <div class="sidebar-left">
                    <!-- Box 1: S·ª≠a th√¥ng tin l√° s·ªë -->
                    <div class="edit-info-box">
                        <h3>Th√¥ng tin l√° s·ªë</h3>
                        <form id="edit-form" method="GET" action="{% url 'lasotuvi_result' %}">
                            <div class="edit-form-group">
                                <label>H·ªç t√™n:</label>
                                <input type="text" name="hoten" value="{{ hoten }}" placeholder="Nh·∫≠p h·ªç t√™n">
                            </div>

                            <div class="edit-form-group">
                                <label>Gi·ªõi t√≠nh:</label>
                                <select name="gioitinh">
                                    <option value="nam" {% if gioitinh == 'nam' %}selected{% endif %}>Nam</option>
                                    <option value="nu" {% if gioitinh == 'nu' %}selected{% endif %}>N·ªØ</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <div class="date-inputs-with-labels">
                                    <div class="date-field">
                                        <label class="date-label">Ng√†y sinh</label>
                                        <select name="ngaysinh" class="date-select">
                                            {% for i in "x"|rjust:"31" %}
                                            <option value="{{ forloop.counter }}" {% if ngaysinh|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">Th√°ng sinh</label>
                                        <select name="thangsinh" class="date-select">
                                            {% for i in "x"|rjust:"12" %}
                                            <option value="{{ forloop.counter }}" {% if thangsinh|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">NƒÉm sinh</label>
                                        <select name="namsinh" class="year-select">
                                            {% for year in birth_year_range %}
                                                <option value="{{ year }}" {% if year|stringformat:"s" == namsinh|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amlich" {% if amlich == 'on' %}checked{% endif %}> √Çm l·ªãch
                                </label>
                            </div>

                            <div class="edit-form-group">
                                <label>Gi·ªù sinh:</label>
                                <select name="giosinh">
                                    <option value="1" {% if giosinh == '1' %}selected{% endif %}>T√Ω (23h-01h)</option>
                                    <option value="2" {% if giosinh == '2' %}selected{% endif %}>S·ª≠u (01h-03h)</option>
                                    <option value="3" {% if giosinh == '3' %}selected{% endif %}>D·∫ßn (03h-05h)</option>
                                    <option value="4" {% if giosinh == '4' %}selected{% endif %}>M√£o (05h-07h)</option>
                                    <option value="5" {% if giosinh == '5' %}selected{% endif %}>Th√¨n (07h-09h)</option>
                                    <option value="6" {% if giosinh == '6' %}selected{% endif %}>T·ªµ (09h-11h)</option>
                                    <option value="7" {% if giosinh == '7' %}selected{% endif %}>Ng·ªç (11h-13h)</option>
                                    <option value="8" {% if giosinh == '8' %}selected{% endif %}>M√πi (13h-15h)</option>
                                    <option value="9" {% if giosinh == '9' %}selected{% endif %}>Th√¢n (15h-17h)</option>
                                    <option value="10" {% if giosinh == '10' %}selected{% endif %}>D·∫≠u (17h-19h)</option>
                                    <option value="11" {% if giosinh == '11' %}selected{% endif %}>Tu·∫•t (19h-21h)</option>
                                    <option value="12" {% if giosinh == '12' %}selected{% endif %}>H·ª£i (21h-23h)</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <label>M√∫i gi·ªù:</label>
                                <select name="muigio">
                                    <option value="0" {% if muigio|stringformat:"s" == '0' %}selected{% endif %}>0</option>
                                    <option value="1" {% if muigio|stringformat:"s" == '1' %}selected{% endif %}>+1</option>
                                    <option value="2" {% if muigio|stringformat:"s" == '2' %}selected{% endif %}>+2</option>
                                    <option value="3" {% if muigio|stringformat:"s" == '3' %}selected{% endif %}>+3</option>
                                    <option value="4" {% if muigio|stringformat:"s" == '4' %}selected{% endif %}>+4</option>
                                    <option value="5" {% if muigio|stringformat:"s" == '5' %}selected{% endif %}>+5</option>
                                    <option value="6" {% if muigio|stringformat:"s" == '6' %}selected{% endif %}>+6</option>
                                    <option value="7" {% if muigio|stringformat:"s" == '7' or muigio == '' %}selected{% endif %}>+7 (Vi·ªát Nam)</option>
                                    <option value="8" {% if muigio|stringformat:"s" == '8' %}selected{% endif %}>+8</option>
                                    <option value="9" {% if muigio|stringformat:"s" == '9' %}selected{% endif %}>+9</option>
                                    <option value="10" {% if muigio|stringformat:"s" == '10' %}selected{% endif %}>+10</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <div class="date-inputs-with-labels">
                                    <div class="date-field">
                                        <label class="date-label">Ng√†y xem</label>
                                        <select name="ngayxem" class="date-select">
                                            {% for i in "x"|rjust:"31" %}
                                            <option value="{{ forloop.counter }}" {% if ngayxem|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">Th√°ng xem</label>
                                        <select name="thangxem" class="date-select">
                                            {% for i in "x"|rjust:"12" %}
                                            <option value="{{ forloop.counter }}" {% if thangxem|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">NƒÉm xem</label>
                                        <select name="namxem" class="year-select">
                                            {% for year in year_range %}
                                                <option value="{{ year }}" {% if year|stringformat:"s" == namxem|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="amlichxem" name="amlichxem" {% if amlichxem == 'on' %}checked{% endif %}> √Çm l·ªãch
                                </label>
                            </div>

                            <!-- Hidden input to preserve laso_id when updating -->
                            <input type="hidden" name="laso_id" id="hidden-laso-id" value="">

                            <button type="submit" class="btn-edit-submit">C·∫≠p nh·∫≠t l√° s·ªë</button>
                        </form>

                        <script>
                        // NOTE: Remove empty laso_id from form submission
                        document.getElementById('edit-form').addEventListener('submit', function(e) {
                            const lasoIdInput = document.getElementById('hidden-laso-id');
                            if (lasoIdInput && !lasoIdInput.value) {
                                lasoIdInput.disabled = true;
                            }
                        });
                        </script>
                    </div>

                    <!-- Box 2: Qu·∫£n l√Ω l√° s·ªë -->
                    <div class="save-laso-box">
                        <h3>Qu·∫£n l√Ω l√° s·ªë</h3>
                        <div class="manage-buttons">
                            <button type="button" class="btn-manage-action" id="btn-save-laso" title="L∆∞u">
                                üíæ
                            </button>
                            <button type="button" class="btn-manage-action" id="btn-favorite-laso" title="Y√™u th√≠ch">
                                ‚ù§Ô∏è
                            </button>
                            <button type="button" class="btn-manage-action" id="btn-move-laso" title="Di chuy·ªÉn">
                                üìÅ
                            </button>
                            <button type="button" class="btn-manage-action" id="btn-download-jpg" title="T·∫£i xu·ªëng JPG">
                                üì•
                            </button>
                        </div>
                    </div>

                    <!-- Box 3: T√πy ch·ªçn hi·ªÉn th·ªã -->
                    <div class="display-options">
                        <h3>T√πy ch·ªçn hi·ªÉn th·ªã</h3>
                        <label class="option-label">
                            <input type="checkbox" id="hienphusao">
                            <span>C√°c ph·ª• tinh</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiencungdaivan">
                            <span>Cung ƒë·∫°i v·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiencungtieuan">
                            <span>Cung ti·ªÉu v·∫≠n (ph√°i L∆∞u Th√°i Tu·∫ø)</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hienhanthang">
                            <span>Th√°ng V·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hienngayvan">
                            <span>Ng√†y V·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiensaoluudaivan">
                            <span>Sao l∆∞u ƒë·∫°i v·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiensaoluutieuan">
                            <span>Sao l∆∞u ti·ªÉu v·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiensaoluunguyetvan">
                            <span>Sao l∆∞u th√°ng v·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiensaoluunhatvan">
                            <span>Sao l∆∞u ng√†y v·∫≠n</span>
                        </label>
                    </div>
                </div>

                <!-- Wrapper cƒÉn gi·ªØa l√° s·ªë -->
                <div class="lasotuvi-grid-wrapper">
                    <!-- Container with position: relative for absolute-positioned Tu·∫ßn markers -->
                    <div class="lasotuvi-grid-container">
                        <!-- Grid 4x4 cho 12 cung + thi√™n b√†n -->
                        <div class="lasotuvi-grid">
                    <!-- H√†ng 1: T·ªµ, Ng·ªç, M√πi, Th√¢n -->
                    <div class="cung" data-cung="6" id="cung-6"></div>
                    <div class="cung" data-cung="7" id="cung-7"></div>
                    <div class="cung" data-cung="8" id="cung-8"></div>
                    <div class="cung" data-cung="9" id="cung-9"></div>

                    <!-- H√†ng 2: Th√¨n, Thi√™n B√†n (colspan 2), D·∫≠u -->
                    <div class="cung" data-cung="5" id="cung-5"></div>
                    <div class="thien-ban" id="thien-ban">
                        <h2>L√Å S·ªê T·ª¨ VI</h2>
                        <div class="thien-ban-content"></div>
                    </div>
                    <div class="cung" data-cung="10" id="cung-10"></div>

                    <!-- H√†ng 3: M√£o, Thi√™n B√†n (ti·∫øp), Tu·∫•t -->
                    <div class="cung" data-cung="4" id="cung-4"></div>
                    <!-- Thi√™n b√†n chi·∫øm 2 √¥ gi·ªØa, d√πng grid-row: span 2 -->
                    <div class="cung" data-cung="11" id="cung-11"></div>

                    <!-- H√†ng 4: D·∫ßn, S·ª≠u, T√Ω, H·ª£i -->
                    <div class="cung" data-cung="3" id="cung-3"></div>
                    <div class="cung" data-cung="2" id="cung-2"></div>
                    <div class="cung" data-cung="1" id="cung-1"></div>
                    <div class="cung" data-cung="12" id="cung-12"></div>
                        </div>
                        <!-- Container for Tu·∫ßn markers (filled by JavaScript) -->
                        <div id="tuan-markers-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªçn th∆∞ m·ª•c ƒë·ªÉ l∆∞u -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>L∆∞u l√° s·ªë m·ªõi</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>T√™n l√° s·ªë:</label>
                    <input type="text" id="laso-name" placeholder="Nh·∫≠p t√™n l√° s·ªë" />
                </div>
                <div class="form-group">
                    <label>Ch·ªçn th∆∞ m·ª•c:</label>
                    <select id="folder-select">
                        <option value="">-- Kh√¥ng c√≥ th∆∞ m·ª•c --</option>
                        <option value="new">+ T·∫°o th∆∞ m·ª•c m·ªõi</option>
                    </select>
                </div>
                <div class="form-group" id="new-folder-group" style="display: none;">
                    <label>T√™n th∆∞ m·ª•c m·ªõi:</label>
                    <input type="text" id="new-folder-name" placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel">H·ªßy</button>
                <button type="button" class="btn-modal-save">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Modal di chuy·ªÉn l√° s·ªë -->
    <div id="move-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Di chuy·ªÉn l√° s·ªë</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ch·ªçn th∆∞ m·ª•c ƒë√≠ch:</label>
                    <select id="move-folder-select">
                        <option value="">-- Ch·ªçn th∆∞ m·ª•c --</option>
                        <option value="create_new">+ T·∫°o th∆∞ m·ª•c m·ªõi</option>
                    </select>
                </div>
                <div class="form-group" id="move-new-folder-group" style="display: none;">
                    <label>T√™n th∆∞ m·ª•c m·ªõi:</label>
                    <input type="text" id="move-new-folder-name" placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" id="btn-move-cancel">H·ªßy</button>
                <button type="button" class="btn-modal-save" id="btn-move-confirm">Di chuy·ªÉn</button>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn global ƒë·ªÉ l∆∞u laso_id v√† th√¥ng tin laso
        let currentLasoId = null;
        let currentLaso = null;

        // T·ª± ƒë·ªông load data khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            // L·∫•y laso_id t·ª´ URL n·∫øu c√≥
            const urlParams = new URLSearchParams(window.location.search);
            currentLasoId = urlParams.get('laso_id');

            // NOTE: Always sync hidden input with URL - clear if no laso_id in URL
            const hiddenLasoIdInput = document.getElementById('hidden-laso-id');
            if (hiddenLasoIdInput) {
                hiddenLasoIdInput.value = currentLasoId || '';
            }

            // N·∫øu c√≥ laso_id, load t·ª´ database tr∆∞·ªõc
            if (currentLasoId) {
                console.log('DEBUG: Loading laso_id:', currentLasoId);

                fetch(`/api/laso/${currentLasoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('DEBUG: API response:', data);
                        if (data.success && data.laso.chart_data) {
                            const laso = data.laso;
                            // L∆∞u v√†o bi·∫øn global
                            currentLaso = laso;
                            console.log('DEBUG: Set currentLaso to:', currentLaso);

                            // ƒêi·ªÅn th√¥ng tin v√†o form
                            // NOTE: ∆Øu ti√™n URL params n·∫øu c√≥ (khi user click "C·∫≠p nh·∫≠t l√° s·ªë")
                            // Ch·ªâ d√πng URL params khi ch√∫ng th·ª±c s·ª± c√≥ gi√° tr·ªã
                            document.querySelector('input[name="hoten"]').value = urlParams.get('hoten') ?? laso.hoten ?? '';
                            document.querySelector('select[name="ngaysinh"]').value = urlParams.get('ngaysinh') ?? laso.ngaysinh ?? '';
                            document.querySelector('select[name="thangsinh"]').value = urlParams.get('thangsinh') ?? laso.thangsinh ?? '';
                            document.querySelector('select[name="namsinh"]').value = urlParams.get('namsinh') ?? laso.namsinh ?? '';
                            document.querySelector('select[name="giosinh"]').value = urlParams.get('giosinh') ?? laso.giosinh ?? '';
                            document.querySelector('select[name="gioitinh"]').value = urlParams.get('gioitinh') ?? laso.gioitinh ?? '';
                            document.querySelector('input[name="amlich"]').checked = urlParams.get('amlich') === 'on' ? true : (laso.amlich || false);
                            document.querySelector('select[name="muigio"]').value = urlParams.get('muigio') ?? laso.muigio ?? 7;
                            // NOTE: ∆Øu ti√™n viewing date t·ª´ URL params (khi user thay ƒë·ªïi v√† click "C·∫≠p nh·∫≠t l√° s·ªë")
                            const ngayxemSelect = document.querySelector('select[name="ngayxem"]');
                            const thangxemSelect = document.querySelector('select[name="thangxem"]');
                            const namxemSelect = document.querySelector('select[name="namxem"]');

                            if (ngayxemSelect) {
                                const ngayxemFromUrl = urlParams.get('ngayxem');
                                const ngayxemFromChart = laso.chart_data?.ngayXem;
                                ngayxemSelect.value = ngayxemFromUrl || ngayxemFromChart || '';
                            }

                            if (thangxemSelect) {
                                const thangxemFromUrl = urlParams.get('thangxem');
                                const thangxemFromChart = laso.chart_data?.thangXem;
                                thangxemSelect.value = thangxemFromUrl || thangxemFromChart || '';
                            }

                            if (namxemSelect) {
                                const namxemFromUrl = urlParams.get('namxem');
                                // NOTE: namxem stored in chart_data.namXem, not laso.namxem
                                const namxemFromChart = laso.chart_data?.namXem;
                                namxemSelect.value = namxemFromUrl || namxemFromChart || '';
                            }

                            // Populate amlichxem checkbox - prioritize current viewing state, then chart_data
                            const amlichxemCheckbox = document.getElementById('amlichxem');
                            if (amlichxemCheckbox) {
                                const amlichxemFromUrl = urlParams.get('amlichxem');
                                const amlichxemFromChart = laso.chart_data?.amlichXem;

                                // Check if we're in "viewing mode" (user just clicked "Xem l√° s·ªë")
                                // by checking if form params exist in URL
                                const isViewingMode = urlParams.has('hoten') || urlParams.has('ngayxem');

                                if (isViewingMode) {
                                    // In viewing mode: amlichxem=on means checked, absence means unchecked
                                    amlichxemCheckbox.checked = (amlichxemFromUrl === 'on');
                                    console.log('DEBUG: Setting amlichxem from viewing mode (URL presence):', amlichxemFromUrl);
                                } else if (amlichxemFromChart !== undefined) {
                                    // Not in viewing mode: use saved chart_data
                                    amlichxemCheckbox.checked = amlichxemFromChart;
                                    console.log('DEBUG: Setting amlichxem from chart_data:', amlichxemFromChart);
                                }

                                // Save to localStorage so it persists
                                localStorage.setItem('checkbox_amlichxem', String(amlichxemCheckbox.checked));
                            }

                            // C·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u th√≠ch cho n√∫t
                            const btnFavorite = document.getElementById('btn-favorite-laso');
                            if (btnFavorite && laso.is_favorite) {
                                btnFavorite.classList.add('favorited');
                            }

                            // Render l√° s·ªë
                            // NOTE: N·∫øu c√≥ params trong URL (user v·ª´a click "C·∫≠p nh·∫≠t l√° s·ªë"),
                            // th√¨ t√≠nh l·∫°i l√° s·ªë t·ª´ API v·ªõi params m·ªõi
                            // Check if there are any params besides laso_id
                            const allParams = new URLSearchParams(window.location.search);
                            allParams.delete('laso_id');
                            const hasOtherParams = allParams.toString().length > 0;

                            if (hasOtherParams) {
                                // User v·ª´a update th√¥ng tin, t√≠nh l·∫°i t·ª´ API
                                const params = new URLSearchParams(window.location.search);
                                // X√≥a laso_id ƒë·ªÉ API t√≠nh to√°n l·∫°i
                                params.delete('laso_id');
                                const apiUrl = '/api?' + params.toString();

                                console.log('DEBUG: Calling API with params:', params.toString());
                                console.log('DEBUG: amlich param:', params.get('amlich'));

                                fetch(apiUrl)
                                    .then(response => response.json())
                                    .then(data => {
                                        renderLaSoTuVi(data);
                                    })
                                    .catch(error => {
                                        console.error('Error recalculating laso:', error);
                                        alert('C√≥ l·ªói x·∫£y ra khi t√≠nh l·∫°i l√° s·ªë!');
                                    });
                            } else {
                                // Load l·∫ßn ƒë·∫ßu, d√πng chart_data t·ª´ database
                                const chartData = laso.chart_data;
                                renderLaSoTuVi(chartData);
                            }
                        } else {
                            alert('Kh√¥ng th·ªÉ t·∫£i l√° s·ªë!');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading saved laso:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i l√° s·ªë!');
                    });
            } else {
                // Kh√¥ng c√≥ laso_id, t√≠nh to√°n l√° s·ªë m·ªõi t·ª´ params
                const params = new URLSearchParams(window.location.search);
                const apiUrl = '/api?' + params.toString();

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        renderLaSoTuVi(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi l·∫≠p l√° s·ªë. Vui l√≤ng th·ª≠ l·∫°i!');
                    });
            }

            // NOTE: Restore checkbox states from localStorage and re-render if needed
            // IMPORTANT: Skip amlichxem if we have a saved laso (chart_data has the correct value)
            const checkboxIds = ['hienphusao', 'hiencungdaivan', 'hiencungtieuan', 'hienhanthang', 'hienngayvan', 'hiensaoluudaivan', 'hiensaoluutieuan', 'hiensaoluunguyetvan', 'hiensaoluunhatvan', 'amlichxem'];
            let needsRerender = false;
            const hasLasoId = new URLSearchParams(window.location.search).get('laso_id');

            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    // Skip amlichxem if we have a saved laso - it's already set from chart_data
                    if (id === 'amlichxem' && hasLasoId) {
                        return;
                    }

                    const savedState = localStorage.getItem(`checkbox_${id}`);
                    if (savedState !== null) {
                        const shouldBeChecked = savedState === 'true';
                        if (checkbox.checked !== shouldBeChecked) {
                            checkbox.checked = shouldBeChecked;
                            needsRerender = true;
                        }
                    }
                }
            });

            // NOTE: Re-render if checkbox states changed
            if (needsRerender && window.currentLaSoData) {
                setTimeout(() => {
                    renderThapNhiCung(
                        window.currentLaSoData.thapNhiCung,
                        window.currentLaSoData.thienBan
                    );
                }, 100);
            }

            // NOTE: Save checkbox states to localStorage when changed
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        localStorage.setItem(`checkbox_${id}`, this.checked);
                    });
                }
            });
        });

        // X·ª≠ l√Ω n√∫t L∆∞u ƒë∆°n gi·∫£n
        const btnSave = document.getElementById('btn-save-laso');
        const modal = document.getElementById('save-modal');
        const btnClose = document.querySelector('.modal-close');
        const btnCancel = document.querySelector('.btn-modal-cancel');
        const folderSelect = document.getElementById('folder-select');
        const newFolderGroup = document.getElementById('new-folder-group');

        if (btnSave) {
            btnSave.addEventListener('click', function() {
                console.log('='.repeat(80));
                console.log('Save button clicked!');
                console.log('currentLaso:', currentLaso);
                console.log('currentLasoId:', currentLasoId);
                console.log('currentLaso.id:', currentLaso?.id);
                console.log('Has currentLaso.id?', !!(currentLaso && currentLaso.id));
                console.log('='.repeat(80));

                // Ki·ªÉm tra xem c√≥ ƒëang xem l√° s·ªë ƒë√£ l∆∞u kh√¥ng
                if (currentLaso && currentLaso.id) {
                    // Hi·ªÉn th·ªã h·ªôp tho·∫°i ch·ªçn: L∆∞u ƒë√® ho·∫∑c L∆∞u m·ªõi
                    const overwrite = confirm('B·∫°n mu·ªën l∆∞u ƒë√® l√° s·ªë "' + currentLaso.name + '" hi·ªán t·∫°i?\n\nCh·ªçn OK ƒë·ªÉ l∆∞u ƒë√®, Cancel ƒë·ªÉ l∆∞u th√†nh l√° s·ªë m·ªõi.');

                    if (overwrite) {
                        // L∆∞u ƒë√® l√° s·ªë hi·ªán t·∫°i
                        handleUpdateLaso();
                    } else {
                        // M·ªü modal ƒë·ªÉ l∆∞u m·ªõi
                        openSaveModal();
                    }
                } else {
                    // L√° s·ªë ch∆∞a l∆∞u, m·ªü modal l∆∞u m·ªõi
                    openSaveModal();
                }
            });
        }

        // H√†m m·ªü modal l∆∞u m·ªõi
        function openSaveModal() {
            console.log('openSaveModal called');
            console.log('modal element:', modal);
            // Load folders
            fetch('/api/folders/')
                .then(response => response.json())
                .then(data => {
                    console.log('Folders loaded:', data);
                    const select = document.getElementById('folder-select');
                    console.log('folder-select element:', select);
                    // X√≥a c√°c option c≈© (tr·ª´ 2 option ƒë·∫ßu)
                    while (select.options.length > 2) {
                        select.remove(2);
                    }
                    // Th√™m folders t·ª´ database
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name + ' (' + folder.laso_count + ' l√° s·ªë)';
                        select.appendChild(option);
                    });
                });
            console.log('Setting modal display to block');
            modal.style.display = 'block';
            console.log('Modal should be visible now');
        }

        // H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t l√° s·ªë
        function handleUpdateLaso() {
            console.log('handleUpdateLaso called');
            const hotenInput = document.querySelector('input[name="hoten"]');
            const ngaysinhSelect = document.querySelector('select[name="ngaysinh"]');
            const thangsinhSelect = document.querySelector('select[name="thangsinh"]');
            const namsinhSelect = document.querySelector('select[name="namsinh"]');
            const giosinhSelect = document.querySelector('select[name="giosinh"]');
            const gioitinhSelect = document.querySelector('select[name="gioitinh"]');
            const amlichCheckbox = document.querySelector('input[name="amlich"]');
            const muigioSelect = document.querySelector('select[name="muigio"]');
            const ngayxemSelect = document.querySelector('select[name="ngayxem"]');
            const thangxemSelect = document.querySelector('select[name="thangxem"]');
            const namxemSelect = document.querySelector('select[name="namxem"]');
            const amlichxemCheckbox = document.getElementById('amlichxem');

            // DEBUG: Log current laso and form values before update
            console.log('========== DEBUG handleUpdateLaso ==========');
            console.log('Current laso.giosinh from DB:', currentLaso.giosinh);
            console.log('Form giosinhSelect.value:', giosinhSelect?.value);
            console.log('===========================================');

            const updateData = {
                laso_id: currentLaso.id,
                hoten: hotenInput?.value || '',
                ngaysinh: ngaysinhSelect?.value || '1',
                thangsinh: thangsinhSelect?.value || '1',
                namsinh: namsinhSelect?.value || '2000',
                giosinh: giosinhSelect?.value || '1',
                gioitinh: gioitinhSelect?.value || 'nam',
                amlich: amlichCheckbox?.checked ? 'on' : 'off',
                muigio: muigioSelect?.value || '7',
                ngayxem: ngayxemSelect?.value || '1',
                thangxem: thangxemSelect?.value || '1',
                namxem: namxemSelect?.value || null,
                amlichxem: amlichxemCheckbox?.checked ? 'on' : 'off'
            };
            console.log('Update data being sent:', updateData);

            // G·ª≠i request c·∫≠p nh·∫≠t
            fetch('/api/update-laso/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ƒê√£ c·∫≠p nh·∫≠t l√° s·ªë "' + currentLaso.name + '" th√†nh c√¥ng!');
                    // Reload trang v·ªõi laso_id ƒë·ªÉ load l·∫°i d·ªØ li·ªáu - force reload to clear cache
                    window.location.href = `/result/?laso_id=${currentLaso.id}`;
                    window.location.reload(true);
                } else {
                    // NOTE: Hi·ªÉn th·ªã th√¥ng b√°o l·ªói d·ªÖ hi·ªÉu h∆°n cho l·ªói UNIQUE constraint
                    const errorMessage = data.message.includes('UNIQUE constraint') || data.message.includes('unique_together')
                        ? 'T√™n l√° s·ªë ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c!'
                        : data.message;
                    alert('L·ªói: ' + errorMessage);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t l√° s·ªë!');
            });
        }

        // ƒê√≥ng modal
        if (btnClose) {
            btnClose.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        if (btnCancel) {
            btnCancel.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // Click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Hi·ªán/·∫©n input t√™n th∆∞ m·ª•c m·ªõi
        folderSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                newFolderGroup.style.display = 'block';
            } else {
                newFolderGroup.style.display = 'none';
            }
        });

        // X·ª≠ l√Ω l∆∞u l√° s·ªë m·ªõi t·ª´ modal
        document.querySelector('.btn-modal-save').addEventListener('click', function() {
            const lasoName = document.getElementById('laso-name').value;
            const folderValue = document.getElementById('folder-select').value;
            const newFolderName = document.getElementById('new-folder-name').value;

            if (!lasoName) {
                alert('Vui l√≤ng nh·∫≠p t√™n l√° s·ªë!');
                return;
            }

            if (folderValue === 'new' && !newFolderName) {
                alert('Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi!');
                return;
            }

            // L·∫•y th√¥ng tin t·ª´ form ·ªü sidebar
            const hotenInput = document.querySelector('input[name="hoten"]');
            const ngaysinhSelect = document.querySelector('select[name="ngaysinh"]');
            const thangsinhSelect = document.querySelector('select[name="thangsinh"]');
            const namsinhSelect = document.querySelector('select[name="namsinh"]');
            const giosinhSelect = document.querySelector('select[name="giosinh"]');
            const gioitinhSelect = document.querySelector('select[name="gioitinh"]');
            const amlichCheckbox = document.querySelector('input[name="amlich"]');
            const muigioSelect = document.querySelector('select[name="muigio"]');
            const namxemSelect = document.querySelector('select[name="namxem"]');

            console.log('DEBUG - Form values:', {
                hoten: hotenInput?.value,
                ngaysinh: ngaysinhSelect?.value,
                thangsinh: thangsinhSelect?.value,
                namsinh: namsinhSelect?.value,
                giosinh: giosinhSelect?.value,
                gioitinh: gioitinhSelect?.value,
                amlich: amlichCheckbox?.checked,
                muigio: muigioSelect?.value,
                namxem: namxemSelect?.value
            });

            const saveData = {
                name: lasoName,
                hoten: hotenInput?.value || '',
                ngaysinh: ngaysinhSelect?.value || '1',
                thangsinh: thangsinhSelect?.value || '1',
                namsinh: namsinhSelect?.value || '2000',
                giosinh: giosinhSelect?.value || '1',
                gioitinh: gioitinhSelect?.value || 'nam',
                amlich: amlichCheckbox?.checked ? 'on' : 'off',
                muigio: muigioSelect?.value || '7',
                namxem: namxemSelect?.value || null
            };

            // Th√™m folder info
            if (folderValue === 'new') {
                saveData.new_folder_name = newFolderName;
            } else if (folderValue) {
                saveData.folder_id = folderValue;
            }

            // G·ª≠i request l∆∞u l√° s·ªë
            fetch('/api/save-laso/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    modal.style.display = 'none';

                    // L∆∞u laso_id v√† th√¥ng tin laso v√†o bi·∫øn global
                    if (data.laso_id) {
                        currentLasoId = data.laso_id;
                        // L∆∞u th√¥ng tin laso v√†o currentLaso
                        currentLaso = {
                            id: data.laso_id,
                            name: lasoName,
                            hoten: saveData.hoten,
                            ngaysinh: saveData.ngaysinh,
                            thangsinh: saveData.thangsinh,
                            namsinh: saveData.namsinh,
                            giosinh: saveData.giosinh,
                            gioitinh: saveData.gioitinh,
                            amlich: saveData.amlich === 'on',
                            muigio: saveData.muigio,
                            namxem: saveData.namxem
                        };
                        // C·∫≠p nh·∫≠t URL v·ªõi laso_id
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('laso_id', data.laso_id);
                        window.history.replaceState({}, '', newUrl);
                    }

                    // Reset form
                    document.getElementById('laso-name').value = '';
                    document.getElementById('folder-select').value = '';
                    document.getElementById('new-folder-name').value = '';
                } else {
                    // NOTE: Hi·ªÉn th·ªã th√¥ng b√°o l·ªói d·ªÖ hi·ªÉu h∆°n cho l·ªói UNIQUE constraint
                    const errorMessage = data.message.includes('UNIQUE constraint') || data.message.includes('unique_together')
                        ? 'T√™n l√° s·ªë ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c!'
                        : data.message;
                    alert('L·ªói: ' + errorMessage);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u l√° s·ªë!');
            });
        });
        // X·ª≠ l√Ω n√∫t Y√™u th√≠ch
        const btnFavorite = document.getElementById('btn-favorite-laso');
        if (btnFavorite) {
            btnFavorite.addEventListener('click', function() {
                if (!currentLasoId) {
                    alert('Vui l√≤ng l∆∞u l√° s·ªë tr∆∞·ªõc khi ƒë√°nh d·∫•u y√™u th√≠ch!');
                    return;
                }

                const lasoId = currentLasoId;

                fetch(`/api/laso/${lasoId}/toggle-favorite/`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // C·∫≠p nh·∫≠t icon v√† class cho n√∫t
                        btnFavorite.innerHTML = '‚ù§Ô∏è';
                        if (data.is_favorite) {
                            btnFavorite.classList.add('favorited');
                        } else {
                            btnFavorite.classList.remove('favorited');
                        }
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra!');
                });
            });
        }

        // X·ª≠ l√Ω n√∫t Di chuy·ªÉn
        const btnMove = document.getElementById('btn-move-laso');
        const moveModal = document.getElementById('move-modal');
        const btnMoveClose = document.querySelector('#move-modal .modal-close');
        const btnMoveCancel = document.getElementById('btn-move-cancel');

        if (btnMove && moveModal) {
            btnMove.addEventListener('click', function() {
                if (!currentLasoId) {
                    alert('Vui l√≤ng l∆∞u l√° s·ªë tr∆∞·ªõc khi di chuy·ªÉn!');
                    return;
                }

                // Load danh s√°ch th∆∞ m·ª•c
                fetch('/api/folders/')
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById('move-folder-select');
                        select.innerHTML = '<option value="">-- Ch·ªçn th∆∞ m·ª•c --</option>';
                        select.innerHTML += '<option value="create_new">+ T·∫°o th∆∞ m·ª•c m·ªõi</option>';
                        data.folders.forEach(folder => {
                            const option = document.createElement('option');
                            option.value = folder.id;
                            option.textContent = folder.name;
                            select.appendChild(option);
                        });
                        moveModal.style.display = 'block';
                    });
            });

            // X·ª≠ l√Ω khi ch·ªçn "T·∫°o th∆∞ m·ª•c m·ªõi"
            document.getElementById('move-folder-select').addEventListener('change', function() {
                const newFolderGroup = document.getElementById('move-new-folder-group');
                if (this.value === 'create_new') {
                    newFolderGroup.style.display = 'block';
                    document.getElementById('move-new-folder-name').focus();
                } else {
                    newFolderGroup.style.display = 'none';
                }
            });

            btnMoveClose.addEventListener('click', function() {
                moveModal.style.display = 'none';
            });

            btnMoveCancel.addEventListener('click', function() {
                moveModal.style.display = 'none';
            });

            // X·ª≠ l√Ω di chuy·ªÉn
            document.getElementById('btn-move-confirm').addEventListener('click', function() {
                const lasoId = currentLasoId;
                const folderSelect = document.getElementById('move-folder-select');
                const folderId = folderSelect.value;

                if (!folderId) {
                    alert('Vui l√≤ng ch·ªçn th∆∞ m·ª•c!');
                    return;
                }

                // N·∫øu ch·ªçn t·∫°o th∆∞ m·ª•c m·ªõi
                if (folderId === 'create_new') {
                    const newFolderName = document.getElementById('move-new-folder-name').value.trim();
                    if (!newFolderName) {
                        alert('Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi!');
                        return;
                    }

                    // T·∫°o th∆∞ m·ª•c m·ªõi tr∆∞·ªõc
                    fetch('/api/folder/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: newFolderName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Sau khi t·∫°o th∆∞ m·ª•c th√†nh c√¥ng, di chuy·ªÉn l√° s·ªë v√†o th∆∞ m·ª•c ƒë√≥
                            return fetch(`/api/laso/${lasoId}/move/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ folder_id: data.folder.id })
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            moveModal.style.display = 'none';
                            document.getElementById('move-new-folder-name').value = '';
                            document.getElementById('move-new-folder-group').style.display = 'none';
                        } else {
                            alert('L·ªói: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
                    });
                } else {
                    // Di chuy·ªÉn v√†o th∆∞ m·ª•c ƒë√£ c√≥
                    fetch(`/api/laso/${lasoId}/move/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ folder_id: folderId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            moveModal.style.display = 'none';
                        } else {
                            alert('L·ªói: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra!');
                    });
                }
            });
        }

        // X·ª≠ l√Ω n√∫t Download JPG
        const btnDownload = document.getElementById('btn-download-jpg');
        if (btnDownload) {
            btnDownload.addEventListener('click', function() {
                // Get the chart container
                const chartElement = document.querySelector('.lasotuvi-grid-wrapper');

                if (!chartElement) {
                    alert('Kh√¥ng t√¨m th·∫•y l√° s·ªë ƒë·ªÉ t·∫£i xu·ªëng!');
                    return;
                }

                // Show loading indicator
                btnDownload.innerHTML = '‚è≥';
                btnDownload.disabled = true;

                // Use html2canvas to capture the chart
                html2canvas(chartElement, {
                    scale: 2,
                    backgroundColor: '#1a1a2e',
                    logging: false,
                    useCORS: true
                }).then(canvas => {
                    // Convert canvas to blob
                    canvas.toBlob(function(blob) {
                        // Create download link
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');

                        // Generate filename
                        const hoten = document.querySelector('input[name="hoten"]')?.value || 'laso';
                        const timestamp = new Date().toISOString().slice(0, 10);
                        link.download = `${hoten}_${timestamp}.jpg`;

                        link.href = url;
                        link.click();

                        // Clean up
                        URL.revokeObjectURL(url);

                        // Reset button
                        btnDownload.innerHTML = 'üì•';
                        btnDownload.disabled = false;
                    }, 'image/jpeg', 0.95);
                }).catch(error => {
                    console.error('Error generating image:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi t·∫°o h√¨nh ·∫£nh!');

                    // Reset button
                    btnDownload.innerHTML = 'üì•';
                    btnDownload.disabled = false;
                });
            });
        }
    </script>
    <script src="{% static 'tuvi/client.js' %}?v=1007"></script>
</body>
</html>
