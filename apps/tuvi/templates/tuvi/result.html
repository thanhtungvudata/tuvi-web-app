<!DOCTYPE html>
<html lang="vi">
{% load static %}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>L√° S·ªë T·ª≠ Vi - K·∫øt qu·∫£</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="{% static 'tuvi/style.css' %}?v=200" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header v·ªõi n√∫t h√†nh ƒë·ªông -->
        <div class="result-header">
            <h1 class="main-title">L√° S·ªë T·ª≠ Vi</h1>
            <div class="action-buttons">
                <a href="{% url 'lasotuvi_index' %}" class="btn btn-secondary">
                    üìÅ Qu·∫£n l√Ω t·∫•t c·∫£ l√° s·ªë
                </a>
                <a href="{% url 'lasotuvi_new' %}" class="btn btn-primary">
                    + T·∫°o l√° s·ªë m·ªõi
                </a>
            </div>
        </div>

        <!-- K·∫øt qu·∫£ l√° s·ªë -->
        <div id="lasotuvi-result" class="result-container">
            <div class="laso-layout">
                <!-- Sidebar b√™n tr√°i -->
                <div class="sidebar-left">
                    <!-- Box 1: S·ª≠a th√¥ng tin l√° s·ªë -->
                    <div class="edit-info-box">
                        <h3>Th√¥ng tin l√° s·ªë</h3>
                        <form id="edit-form" method="GET" action="{% url 'lasotuvi_result' %}">
                            <div class="edit-form-group">
                                <label>H·ªç t√™n:</label>
                                <input type="text" name="hoten" value="{{ hoten }}" placeholder="Nh·∫≠p h·ªç t√™n">
                            </div>

                            <div class="edit-form-group">
                                <label>Gi·ªõi t√≠nh:</label>
                                <select name="gioitinh">
                                    <option value="nam" {% if gioitinh == 'nam' %}selected{% endif %}>Nam</option>
                                    <option value="nu" {% if gioitinh == 'nu' %}selected{% endif %}>N·ªØ</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <div class="date-inputs-with-labels">
                                    <div class="date-field">
                                        <label class="date-label">Ng√†y</label>
                                        <select name="ngaysinh" class="date-select">
                                            {% for i in "x"|rjust:"31" %}
                                            <option value="{{ forloop.counter }}" {% if ngaysinh|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">Th√°ng</label>
                                        <select name="thangsinh" class="date-select">
                                            {% for i in "x"|rjust:"12" %}
                                            <option value="{{ forloop.counter }}" {% if thangsinh|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="date-field">
                                        <label class="date-label">NƒÉm</label>
                                        <input type="text" name="namsinh" value="{{ namsinh }}" placeholder="NƒÉm" class="year-input">
                                    </div>
                                </div>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="amlich" {% if amlich == 'on' %}checked{% endif %}> √Çm l·ªãch
                                </label>
                            </div>

                            <div class="edit-form-group">
                                <label>Gi·ªù sinh:</label>
                                <select name="giosinh">
                                    <option value="1" {% if giosinh == '1' %}selected{% endif %}>T√Ω (23h-01h)</option>
                                    <option value="2" {% if giosinh == '2' %}selected{% endif %}>S·ª≠u (01h-03h)</option>
                                    <option value="3" {% if giosinh == '3' %}selected{% endif %}>D·∫ßn (03h-05h)</option>
                                    <option value="4" {% if giosinh == '4' %}selected{% endif %}>M√£o (05h-07h)</option>
                                    <option value="5" {% if giosinh == '5' %}selected{% endif %}>Th√¨n (07h-09h)</option>
                                    <option value="6" {% if giosinh == '6' %}selected{% endif %}>T·ªµ (09h-11h)</option>
                                    <option value="7" {% if giosinh == '7' %}selected{% endif %}>Ng·ªç (11h-13h)</option>
                                    <option value="8" {% if giosinh == '8' %}selected{% endif %}>M√πi (13h-15h)</option>
                                    <option value="9" {% if giosinh == '9' %}selected{% endif %}>Th√¢n (15h-17h)</option>
                                    <option value="10" {% if giosinh == '10' %}selected{% endif %}>D·∫≠u (17h-19h)</option>
                                    <option value="11" {% if giosinh == '11' %}selected{% endif %}>Tu·∫•t (19h-21h)</option>
                                    <option value="12" {% if giosinh == '12' %}selected{% endif %}>H·ª£i (21h-23h)</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <label>M√∫i gi·ªù:</label>
                                <select name="muigio">
                                    <option value="7" {% if muigio == '7' or muigio == '' %}selected{% endif %}>+7 (Vi·ªát Nam)</option>
                                    <option value="0">0</option>
                                    <option value="1">+1</option>
                                    <option value="2">+2</option>
                                    <option value="3">+3</option>
                                    <option value="4">+4</option>
                                    <option value="5">+5</option>
                                    <option value="6">+6</option>
                                    <option value="8">+8</option>
                                    <option value="9">+9</option>
                                    <option value="10">+10</option>
                                </select>
                            </div>

                            <div class="edit-form-group">
                                <label>NƒÉm xem:</label>
                                <input type="number" name="namxem" value="{{ namxem }}" placeholder="Nh·∫≠p nƒÉm xem" min="1900" max="2100">
                            </div>

                            <!-- Hidden input to preserve laso_id when updating -->
                            <input type="hidden" name="laso_id" id="hidden-laso-id" value="">

                            <button type="submit" class="btn-edit-submit">C·∫≠p nh·∫≠t l√° s·ªë</button>
                        </form>
                    </div>

                    <!-- Box 2: Qu·∫£n l√Ω l√° s·ªë -->
                    <div class="save-laso-box">
                        <h3>Qu·∫£n l√Ω l√° s·ªë</h3>
                        <div class="manage-buttons">
                            <button type="button" class="btn-manage-action" id="btn-save-laso" title="L∆∞u">
                                üíæ
                            </button>
                            <button type="button" class="btn-manage-action" id="btn-favorite-laso" title="Y√™u th√≠ch">
                                ‚ù§Ô∏è
                            </button>
                            <button type="button" class="btn-manage-action" id="btn-move-laso" title="Di chuy·ªÉn">
                                üìÅ
                            </button>
                        </div>
                    </div>

                    <!-- Box 3: T√πy ch·ªçn hi·ªÉn th·ªã -->
                    <div class="display-options">
                        <h3>T√πy ch·ªçn hi·ªÉn th·ªã</h3>
                        <label class="option-label">
                            <input type="checkbox" id="hienphusao">
                            <span>C√°c ph·ª• tinh</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiencungdaivan">
                            <span>Cung ƒë·∫°i v·∫≠n</span>
                        </label>
                        <br>
                        <label class="option-label">
                            <input type="checkbox" id="hiencungtieuan">
                            <span>Cung ti·ªÉu v·∫≠n</span>
                        </label>
                    </div>
                </div>

                <!-- Wrapper cƒÉn gi·ªØa l√° s·ªë -->
                <div class="lasotuvi-grid-wrapper">
                    <!-- Container with position: relative for absolute-positioned Tu·∫ßn markers -->
                    <div class="lasotuvi-grid-container">
                        <!-- Grid 4x4 cho 12 cung + thi√™n b√†n -->
                        <div class="lasotuvi-grid">
                    <!-- H√†ng 1: T·ªµ, Ng·ªç, M√πi, Th√¢n -->
                    <div class="cung" data-cung="6" id="cung-6"></div>
                    <div class="cung" data-cung="7" id="cung-7"></div>
                    <div class="cung" data-cung="8" id="cung-8"></div>
                    <div class="cung" data-cung="9" id="cung-9"></div>

                    <!-- H√†ng 2: Th√¨n, Thi√™n B√†n (colspan 2), D·∫≠u -->
                    <div class="cung" data-cung="5" id="cung-5"></div>
                    <div class="thien-ban" id="thien-ban">
                        <h2>L√Å S·ªê T·ª¨ VI</h2>
                        <div class="thien-ban-content"></div>
                    </div>
                    <div class="cung" data-cung="10" id="cung-10"></div>

                    <!-- H√†ng 3: M√£o, Thi√™n B√†n (ti·∫øp), Tu·∫•t -->
                    <div class="cung" data-cung="4" id="cung-4"></div>
                    <!-- Thi√™n b√†n chi·∫øm 2 √¥ gi·ªØa, d√πng grid-row: span 2 -->
                    <div class="cung" data-cung="11" id="cung-11"></div>

                    <!-- H√†ng 4: D·∫ßn, S·ª≠u, T√Ω, H·ª£i -->
                    <div class="cung" data-cung="3" id="cung-3"></div>
                    <div class="cung" data-cung="2" id="cung-2"></div>
                    <div class="cung" data-cung="1" id="cung-1"></div>
                    <div class="cung" data-cung="12" id="cung-12"></div>
                        </div>
                        <!-- Container for Tu·∫ßn markers (filled by JavaScript) -->
                        <div id="tuan-markers-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ch·ªçn th∆∞ m·ª•c ƒë·ªÉ l∆∞u -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>L∆∞u l√° s·ªë m·ªõi</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>T√™n l√° s·ªë:</label>
                    <input type="text" id="laso-name" placeholder="Nh·∫≠p t√™n l√° s·ªë" />
                </div>
                <div class="form-group">
                    <label>Ch·ªçn th∆∞ m·ª•c:</label>
                    <select id="folder-select">
                        <option value="">-- Kh√¥ng c√≥ th∆∞ m·ª•c --</option>
                        <option value="new">+ T·∫°o th∆∞ m·ª•c m·ªõi</option>
                    </select>
                </div>
                <div class="form-group" id="new-folder-group" style="display: none;">
                    <label>T√™n th∆∞ m·ª•c m·ªõi:</label>
                    <input type="text" id="new-folder-name" placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel">H·ªßy</button>
                <button type="button" class="btn-modal-save">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Modal di chuy·ªÉn l√° s·ªë -->
    <div id="move-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Di chuy·ªÉn l√° s·ªë</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Ch·ªçn th∆∞ m·ª•c ƒë√≠ch:</label>
                    <select id="move-folder-select">
                        <option value="">-- Ch·ªçn th∆∞ m·ª•c --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-cancel" id="btn-move-cancel">H·ªßy</button>
                <button type="button" class="btn-modal-save" id="btn-move-confirm">Di chuy·ªÉn</button>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn global ƒë·ªÉ l∆∞u laso_id v√† th√¥ng tin laso
        let currentLasoId = null;
        let currentLaso = null;

        // T·ª± ƒë·ªông load data khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            // L·∫•y laso_id t·ª´ URL n·∫øu c√≥
            const urlParams = new URLSearchParams(window.location.search);
            currentLasoId = urlParams.get('laso_id');

            // N·∫øu c√≥ laso_id, load t·ª´ database tr∆∞·ªõc
            if (currentLasoId) {
                console.log('DEBUG: Loading laso_id:', currentLasoId);
                // Set hidden input ƒë·ªÉ gi·ªØ laso_id khi submit form
                const hiddenLasoIdInput = document.getElementById('hidden-laso-id');
                if (hiddenLasoIdInput) {
                    hiddenLasoIdInput.value = currentLasoId;
                }

                fetch(`/api/laso/${currentLasoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('DEBUG: API response:', data);
                        if (data.success && data.laso.chart_data) {
                            const laso = data.laso;
                            // L∆∞u v√†o bi·∫øn global
                            currentLaso = laso;
                            console.log('DEBUG: Set currentLaso to:', currentLaso);

                            // ƒêi·ªÅn th√¥ng tin v√†o form
                            // NOTE: ∆Øu ti√™n URL params n·∫øu c√≥ (khi user click "C·∫≠p nh·∫≠t l√° s·ªë")
                            document.querySelector('input[name="hoten"]').value = urlParams.get('hoten') || laso.hoten || '';
                            document.querySelector('select[name="ngaysinh"]').value = urlParams.get('ngaysinh') || laso.ngaysinh || '';
                            document.querySelector('select[name="thangsinh"]').value = urlParams.get('thangsinh') || laso.thangsinh || '';
                            document.querySelector('input[name="namsinh"]').value = urlParams.get('namsinh') || laso.namsinh || '';
                            document.querySelector('select[name="giosinh"]').value = urlParams.get('giosinh') || laso.giosinh || '';
                            document.querySelector('select[name="gioitinh"]').value = urlParams.get('gioitinh') || laso.gioitinh || '';
                            document.querySelector('input[name="amlich"]').checked = urlParams.get('amlich') === 'on' ? true : (laso.amlich || false);
                            document.querySelector('select[name="muigio"]').value = urlParams.get('muigio') || laso.muigio || 7;
                            // NOTE: ∆Øu ti√™n namxem t·ª´ URL params (khi user thay ƒë·ªïi v√† click "C·∫≠p nh·∫≠t l√° s·ªë")
                            const namxemInput = document.querySelector('input[name="namxem"]');
                            const namxemFromUrl = urlParams.get('namxem');
                            if (namxemInput) {
                                namxemInput.value = namxemFromUrl || laso.namxem || '';
                            }

                            // C·∫≠p nh·∫≠t tr·∫°ng th√°i y√™u th√≠ch cho n√∫t
                            const btnFavorite = document.getElementById('btn-favorite-laso');
                            if (btnFavorite && laso.is_favorite) {
                                btnFavorite.classList.add('favorited');
                            }

                            // Render l√° s·ªë
                            // NOTE: N·∫øu c√≥ params trong URL (user v·ª´a click "C·∫≠p nh·∫≠t l√° s·ªë"),
                            // th√¨ t√≠nh l·∫°i l√° s·ªë t·ª´ API v·ªõi params m·ªõi
                            const hasOtherParams = urlParams.get('hoten') || urlParams.get('namxem') ||
                                                   urlParams.get('ngaysinh') || urlParams.get('giosinh');
                            if (hasOtherParams) {
                                // User v·ª´a update th√¥ng tin, t√≠nh l·∫°i t·ª´ API
                                const params = new URLSearchParams(window.location.search);
                                // X√≥a laso_id ƒë·ªÉ API t√≠nh to√°n l·∫°i
                                params.delete('laso_id');
                                const apiUrl = '/api?' + params.toString();

                                fetch(apiUrl)
                                    .then(response => response.json())
                                    .then(data => {
                                        renderLaSoTuVi(data);
                                    })
                                    .catch(error => {
                                        console.error('Error recalculating laso:', error);
                                        alert('C√≥ l·ªói x·∫£y ra khi t√≠nh l·∫°i l√° s·ªë!');
                                    });
                            } else {
                                // Load l·∫ßn ƒë·∫ßu, d√πng chart_data t·ª´ database
                                const chartData = laso.chart_data;
                                renderLaSoTuVi(chartData);
                            }
                        } else {
                            alert('Kh√¥ng th·ªÉ t·∫£i l√° s·ªë!');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading saved laso:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i l√° s·ªë!');
                    });
            } else {
                // Kh√¥ng c√≥ laso_id, t√≠nh to√°n l√° s·ªë m·ªõi t·ª´ params
                const params = new URLSearchParams(window.location.search);
                const apiUrl = '/api?' + params.toString();

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        renderLaSoTuVi(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('C√≥ l·ªói x·∫£y ra khi l·∫≠p l√° s·ªë. Vui l√≤ng th·ª≠ l·∫°i!');
                    });
            }
        });

        // X·ª≠ l√Ω n√∫t L∆∞u ƒë∆°n gi·∫£n
        const btnSave = document.getElementById('btn-save-laso');
        const modal = document.getElementById('save-modal');
        const btnClose = document.querySelector('.modal-close');
        const btnCancel = document.querySelector('.btn-modal-cancel');
        const folderSelect = document.getElementById('folder-select');
        const newFolderGroup = document.getElementById('new-folder-group');

        if (btnSave) {
            btnSave.addEventListener('click', function() {
                console.log('='.repeat(80));
                console.log('Save button clicked!');
                console.log('currentLaso:', currentLaso);
                console.log('currentLasoId:', currentLasoId);
                console.log('currentLaso.id:', currentLaso?.id);
                console.log('Has currentLaso.id?', !!(currentLaso && currentLaso.id));
                console.log('='.repeat(80));

                // Ki·ªÉm tra xem c√≥ ƒëang xem l√° s·ªë ƒë√£ l∆∞u kh√¥ng
                if (currentLaso && currentLaso.id) {
                    // Hi·ªÉn th·ªã h·ªôp tho·∫°i ch·ªçn: L∆∞u ƒë√® ho·∫∑c L∆∞u m·ªõi
                    const overwrite = confirm('B·∫°n mu·ªën l∆∞u ƒë√® l√° s·ªë "' + currentLaso.name + '" hi·ªán t·∫°i?\n\nCh·ªçn OK ƒë·ªÉ l∆∞u ƒë√®, Cancel ƒë·ªÉ l∆∞u th√†nh l√° s·ªë m·ªõi.');

                    if (overwrite) {
                        // L∆∞u ƒë√® l√° s·ªë hi·ªán t·∫°i
                        handleUpdateLaso();
                    } else {
                        // M·ªü modal ƒë·ªÉ l∆∞u m·ªõi
                        openSaveModal();
                    }
                } else {
                    // L√° s·ªë ch∆∞a l∆∞u, m·ªü modal l∆∞u m·ªõi
                    openSaveModal();
                }
            });
        }

        // H√†m m·ªü modal l∆∞u m·ªõi
        function openSaveModal() {
            // Load folders
            fetch('/api/folders/')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('folder-select');
                    // X√≥a c√°c option c≈© (tr·ª´ 2 option ƒë·∫ßu)
                    while (select.options.length > 2) {
                        select.remove(2);
                    }
                    // Th√™m folders t·ª´ database
                    data.folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = folder.name + ' (' + folder.laso_count + ' l√° s·ªë)';
                        select.appendChild(option);
                    });
                });
            modal.style.display = 'block';
        }

        // H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t l√° s·ªë
        function handleUpdateLaso() {
            console.log('handleUpdateLaso called');
            const hotenInput = document.querySelector('input[name="hoten"]');
            const ngaysinhSelect = document.querySelector('select[name="ngaysinh"]');
            const thangsinhSelect = document.querySelector('select[name="thangsinh"]');
            const namsinhInput = document.querySelector('input[name="namsinh"]');
            const giosinhSelect = document.querySelector('select[name="giosinh"]');
            const gioitinhSelect = document.querySelector('select[name="gioitinh"]');
            const amlichCheckbox = document.querySelector('input[name="amlich"]');
            const muigioSelect = document.querySelector('select[name="muigio"]');
            const namxemInput = document.querySelector('input[name="namxem"]');

            const updateData = {
                laso_id: currentLaso.id,
                hoten: hotenInput?.value || '',
                ngaysinh: ngaysinhSelect?.value || '1',
                thangsinh: thangsinhSelect?.value || '1',
                namsinh: namsinhInput?.value || '2000',
                giosinh: giosinhSelect?.value || '1',
                gioitinh: gioitinhSelect?.value || 'nam',
                amlich: amlichCheckbox?.checked ? 'on' : 'off',
                muigio: muigioSelect?.value || '7',
                namxem: namxemInput?.value || null
            };

            // G·ª≠i request c·∫≠p nh·∫≠t
            fetch('/api/update-laso/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ƒê√£ c·∫≠p nh·∫≠t l√° s·ªë "' + currentLaso.name + '" th√†nh c√¥ng!');
                    // Reload trang v·ªõi laso_id ƒë·ªÉ load l·∫°i d·ªØ li·ªáu
                    window.location.href = `/result/?laso_id=${currentLaso.id}`;
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t l√° s·ªë!');
            });
        }

        // ƒê√≥ng modal
        if (btnClose) {
            btnClose.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        if (btnCancel) {
            btnCancel.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // Click b√™n ngo√†i modal ƒë·ªÉ ƒë√≥ng
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Hi·ªán/·∫©n input t√™n th∆∞ m·ª•c m·ªõi
        folderSelect.addEventListener('change', function() {
            if (this.value === 'new') {
                newFolderGroup.style.display = 'block';
            } else {
                newFolderGroup.style.display = 'none';
            }
        });

        // X·ª≠ l√Ω l∆∞u l√° s·ªë m·ªõi t·ª´ modal
        document.querySelector('.btn-modal-save').addEventListener('click', function() {
            const lasoName = document.getElementById('laso-name').value;
            const folderValue = document.getElementById('folder-select').value;
            const newFolderName = document.getElementById('new-folder-name').value;

            if (!lasoName) {
                alert('Vui l√≤ng nh·∫≠p t√™n l√° s·ªë!');
                return;
            }

            if (folderValue === 'new' && !newFolderName) {
                alert('Vui l√≤ng nh·∫≠p t√™n th∆∞ m·ª•c m·ªõi!');
                return;
            }

            // L·∫•y th√¥ng tin t·ª´ form ·ªü sidebar
            const hotenInput = document.querySelector('input[name="hoten"]');
            const ngaysinhSelect = document.querySelector('select[name="ngaysinh"]');
            const thangsinhSelect = document.querySelector('select[name="thangsinh"]');
            const namsinhInput = document.querySelector('input[name="namsinh"]');
            const giosinhSelect = document.querySelector('select[name="giosinh"]');
            const gioitinhSelect = document.querySelector('select[name="gioitinh"]');
            const amlichCheckbox = document.querySelector('input[name="amlich"]');
            const muigioSelect = document.querySelector('select[name="muigio"]');
            const namxemInput = document.querySelector('input[name="namxem"]');

            console.log('DEBUG - Form values:', {
                hoten: hotenInput?.value,
                ngaysinh: ngaysinhSelect?.value,
                thangsinh: thangsinhSelect?.value,
                namsinh: namsinhInput?.value,
                giosinh: giosinhSelect?.value,
                gioitinh: gioitinhSelect?.value,
                amlich: amlichCheckbox?.checked,
                muigio: muigioSelect?.value,
                namxem: namxemInput?.value
            });

            const saveData = {
                name: lasoName,
                hoten: hotenInput?.value || '',
                ngaysinh: ngaysinhSelect?.value || '1',
                thangsinh: thangsinhSelect?.value || '1',
                namsinh: namsinhInput?.value || '2000',
                giosinh: giosinhSelect?.value || '1',
                gioitinh: gioitinhSelect?.value || 'nam',
                amlich: amlichCheckbox?.checked ? 'on' : 'off',
                muigio: muigioSelect?.value || '7',
                namxem: namxemInput?.value || null
            };

            // Th√™m folder info
            if (folderValue === 'new') {
                saveData.new_folder_name = newFolderName;
            } else if (folderValue) {
                saveData.folder_id = folderValue;
            }

            // G·ª≠i request l∆∞u l√° s·ªë
            fetch('/api/save-laso/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(saveData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    modal.style.display = 'none';

                    // L∆∞u laso_id v√† th√¥ng tin laso v√†o bi·∫øn global
                    if (data.laso_id) {
                        currentLasoId = data.laso_id;
                        // L∆∞u th√¥ng tin laso v√†o currentLaso
                        currentLaso = {
                            id: data.laso_id,
                            name: lasoName,
                            hoten: saveData.hoten,
                            ngaysinh: saveData.ngaysinh,
                            thangsinh: saveData.thangsinh,
                            namsinh: saveData.namsinh,
                            giosinh: saveData.giosinh,
                            gioitinh: saveData.gioitinh,
                            amlich: saveData.amlich === 'on',
                            muigio: saveData.muigio,
                            namxem: saveData.namxem
                        };
                        // C·∫≠p nh·∫≠t URL v·ªõi laso_id
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('laso_id', data.laso_id);
                        window.history.replaceState({}, '', newUrl);
                    }

                    // Reset form
                    document.getElementById('laso-name').value = '';
                    document.getElementById('folder-select').value = '';
                    document.getElementById('new-folder-name').value = '';
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u l√° s·ªë!');
            });
        });
        // X·ª≠ l√Ω n√∫t Y√™u th√≠ch
        const btnFavorite = document.getElementById('btn-favorite-laso');
        if (btnFavorite) {
            btnFavorite.addEventListener('click', function() {
                if (!currentLasoId) {
                    alert('Vui l√≤ng l∆∞u l√° s·ªë tr∆∞·ªõc khi ƒë√°nh d·∫•u y√™u th√≠ch!');
                    return;
                }

                const lasoId = currentLasoId;

                fetch(`/api/laso/${lasoId}/toggle-favorite/`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        // C·∫≠p nh·∫≠t icon v√† class cho n√∫t
                        btnFavorite.innerHTML = '‚ù§Ô∏è';
                        if (data.is_favorite) {
                            btnFavorite.classList.add('favorited');
                        } else {
                            btnFavorite.classList.remove('favorited');
                        }
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra!');
                });
            });
        }

        // X·ª≠ l√Ω n√∫t Di chuy·ªÉn
        const btnMove = document.getElementById('btn-move-laso');
        const moveModal = document.getElementById('move-modal');
        const btnMoveClose = document.querySelector('#move-modal .modal-close');
        const btnMoveCancel = document.getElementById('btn-move-cancel');

        if (btnMove && moveModal) {
            btnMove.addEventListener('click', function() {
                if (!currentLasoId) {
                    alert('Vui l√≤ng l∆∞u l√° s·ªë tr∆∞·ªõc khi di chuy·ªÉn!');
                    return;
                }

                // Load danh s√°ch th∆∞ m·ª•c
                fetch('/api/folders/')
                    .then(response => response.json())
                    .then(data => {
                        const select = document.getElementById('move-folder-select');
                        select.innerHTML = '<option value="">-- Ch·ªçn th∆∞ m·ª•c --</option>';
                        data.folders.forEach(folder => {
                            const option = document.createElement('option');
                            option.value = folder.id;
                            option.textContent = folder.name;
                            select.appendChild(option);
                        });
                        moveModal.style.display = 'block';
                    });
            });

            btnMoveClose.addEventListener('click', function() {
                moveModal.style.display = 'none';
            });

            btnMoveCancel.addEventListener('click', function() {
                moveModal.style.display = 'none';
            });

            // X·ª≠ l√Ω di chuy·ªÉn
            document.getElementById('btn-move-confirm').addEventListener('click', function() {
                const lasoId = currentLasoId;
                const folderId = document.getElementById('move-folder-select').value;

                if (!folderId) {
                    alert('Vui l√≤ng ch·ªçn th∆∞ m·ª•c!');
                    return;
                }

                fetch(`/api/laso/${lasoId}/move/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folder_id: folderId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        moveModal.style.display = 'none';
                    } else {
                        alert('L·ªói: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra!');
                });
            });
        }
    </script>
    <script src="{% static 'tuvi/client.js' %}?v=999"></script>
</body>
</html>
